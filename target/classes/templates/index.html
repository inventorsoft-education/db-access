<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Thymeleaf</title>
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet" type="text/css">
    <link th:href="@{/css/main.css}" rel="stylesheet" type="text/css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>


</head>

<body>
<H1>Messages</H1>
<div>
    <table id="my_table" class="table">
        <thead class="thead-dark">
        <tr>
            <th scope="col">id</th>
            <th scope="col">subject</th>
            <th scope="col">emailTo</th>
            <th scope="col">message</th>
            <th scope="col">futureSecond</th>
            <th scope="col">status</th>
            <th scope="col">remove / change</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <div class="popup" id="change_time" style="display:none">
        <div class="object" style="text-align: center">
            <form action= "" method= "">
                <p>Future date :
                    <input id="change_date" type= "number" name= "date">
                    <input type= "submit" id="change_btn" value= "ok">
                </p>
            </form>
        </div>
    </div>
    <div class="popup" id="new_mess" style="display:none">
        <div class="object" style="text-align: center">
            <form action= "" id="contact-form" name="message">
                <p>
                    <b>New message :</b>
                    subject
                    <input id="input_subject" type= "text">
                    email to
                    <input id="input_emailTo" type= "text">
                    message
                    <input id="input_message" type= "text">
                    second
                    <input id="input_futureSecond" type= "number">

                    <input type= "submit" id="btn_ok" value= "ok">
                </p>
            </form>
        </div>
    </div>
    <button id="test">Load Table</button>
    <button id="btn_add">add Message</button>
    </li>
    </ul>
    <script>
               $(document).ready(function() {

                $("#btn_add").on('click', function() {
                    $('#new_mess').show();
                    $('#btn_ok').on('click', function() {
                        var subject = $('#input_subject').val();
                        var emailTo = $('#input_emailTo').val();
                        var message = $('#input_message').val();
                        var futureSecond = $('#input_futureSecond').val();

                        var mess = {
                            subject: subject,
                            emailTo: emailTo,
                            message: message,
                            futureSecond: futureSecond,
                            status: "NOT_SENT"
                        };


                        $.ajax({
                            type: 'POST',
                            url: '/messages/',
                            data: mess,
                            success: function() {
                            }
                        })
                    })
                })


                $("#test").click(function() {
                    $.ajax({
                        type: 'GET',
                        url: '/messages/',
                        dataType: 'json',
                        cache: false,
                        traditional: true,
                        success: function(response) {
                            for (let i = 0; i < response.length; i++) {
                                $('#my_table').append(
                                    "<tr id='" + response[i].id + "Row'><td>" + response[i].id +
                                    "</td><td>" + response[i].subject +
                                    "</td><td>" + response[i].emailTo +
                                    "</td><td>" + response[i].message +
                                    "</td><td>" + response[i].futureSecond +
                                    "</td><td>" + response[i].status +
                                    "</td><td> <button id='btn_delete' data= '" + response[i].id + "' >Delete</button>" + " " +
                                    "<button id='btn_change' data= '" + response[i].id + "' >Change</button></td></tr>");
                            }

                            $('#my_table').on('click', '#btn_delete', function() {
                                var idBtn = $(this).attr("data");
                                var idRow = idBtn + "Row";
                                $.ajax({
                                    type: 'DELETE',
                                    url: '/messages/' + idBtn,
                                    success: function() {
                                        $('#' + idRow).remove();
                                    }
                                })
                            })

                            $('#my_table').on('click', '#btn_change', function() {
                                var idBtn = $(this).attr("data");

                                $('#change_time').show();
                                $('#change_time').on('click', '#change_btn', function() {
                                    var inputDate = $('#change_date').val();
                                    $.ajax({
                                        type: 'PUT',
                                        url: '/messages/' + idBtn,
                                        data: {
                                            'date': inputDate
                                        },
                                        success: function() {}
                                    })
                                })
                            })
                        }
                    });
                });
            });
            </script>
</div>
</body>
</html>